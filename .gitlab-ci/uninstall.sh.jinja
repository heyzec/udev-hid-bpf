#!/usr/bin/env bash
#
# Usage: uninstall.sh [-v|--verbose] [--dry-run] [--list] [---interactive] [--udevdir /etc/] [--prefix $PREFIX] [GLOB]
#
# Description:
#     Uninstalls the BPF programs and udev rules previously installed by install.sh.
#     For this script to work correctly, path arguments must match the paths
#     provided to install.sh.
#
#     After running this script, unplug and re-plug the device.
#
# Arguments:
#     GLOB       ... An optional shell glob to limit the number of BPF programs
#                    to uninstall. Note that this glob needs to be in quotes, e.g. "*XPPen*".
#                    If omitted, all BPF programs in this tarball are uninstalled.
#
# Options:
#     --verbose  ... print debug output
#     --dry-run  ... only print commands, do not uninstall
#     --interactive  ask for confirmation for each BPF to install
#     --list     ... print the BPF files this script can install
#     --prefix   ... prefix for all files (default: /usr/local)
#     --udevdir  ... path to the udev directory to uninstall rules and hwdb files in

# Generated by {{pipeline_url}}

SCRIPT_DIR=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
PREFIX=/usr/local

BPFS=({% for bpf in bpfs %}"{{bpf.filename}}" {% endfor %})

usage () {
  # Prints anyhing from the first line that is '#\n' to the first empty line
  sed -n -e '/^#$/,/^$/s/^#[ ]\?//p' "${BASH_SOURCE[0]}"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --help)
      usage
      exit 0
      ;;
    --interactive)
      INTERACTIVE="y"
      shift;
      ;;
    --verbose|-v)
      set -x
      shift
      ;;
    --dry-run)
      echo "--dry-run given, nothing will be installed and no command is run"
      DRY_RUN="echo"
      shift
      ;;
    --list)
      for bpf in "${BPFS[@]}"; do
        echo "$bpf"
      done
      exit 0
      ;;
    --prefix)
      PREFIX=$2
      shift 2
      ;;
    --udevdir)
      UDEVDIR=$2
      shift 2
      ;;
    --*)
      usage
      exit 1
      ;;
    *)
      break;
      ;;
  esac
done

GLOB=""

if [ $# -gt 0 ]; then
  if [ $# -gt 1 ]; then
    usage
    exit 1
  fi
  GLOB=$1
  shift
fi

set -e

if [ -z "$UDEVDIR" ]; then
  case ${PREFIX%/} in
    /usr)
      UDEVDIR="/usr/lib"
      ;;
    *)
      UDEVDIR="/etc"
      ;;
  esac
fi

echo "Using sudo to remove files from $PREFIX. You may be asked for your password now"
dryrun_sudo="$DRY_RUN sudo"
# Any of the following lines can be safely commented out or removed
# to avoid removing a particular file
{% for bpf in bpfs %}
# shellcheck disable=SC2053
if [[ -z "$GLOB" || "{{bpf.filename}}" = $GLOB ]]; then
  if [[ -n "$INTERACTIVE" ]]; then
    read -rp "Remove {{bpf.filename}}? [y/N] " INSTALL_INTERACTIVE
  fi
  if [[ -z "$INTERACTIVE" || $INSTALL_INTERACTIVE = [yY] ]]; then
    $dryrun_sudo rm -f "$PREFIX/{{bpf.path}}"
  fi
fi
{% endfor %}
# The following lines are generic and should be left as-is
{% for udev in udev_rules %}
$dryrun_sudo rm -f "$UDEVDIR"/udev/rules.d/{{udev.filename}}
{% endfor %}
{% for hwdb in hwdb_files %}
$dryrun_sudo rm -f "$UDEVDIR"/udev/hwdb.d/{{hwdb.filename}}
{% endfor %}
$dryrun_sudo rm -f "$PREFIX"/bin/udev-hid-bpf
$DRY_RUN sudo udevadm control --reload
$DRY_RUN sudo systemd-hwdb update
